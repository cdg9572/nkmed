<head>
	<meta charset="euc-kr" />
	<meta name="viewport" content="width=device-width">
	<meta name="viewport" content="initial-scale=1.0">
	<title> 학생검진 예약 현황 </title>
</head>
<style>
.ht {
	font-weight : bold;
}

.blue{
	color: blue;
}

.red{
	color: red;
}
</style>
<?

#echo "달력만들기";
global $gd, $od;
if( $_GET["ym"]=="" ){ $ym = substr(date("Y-m-d"),0,7); }else{	$ym=$_GET["ym"];	}
#echo $ym;
$y = substr($ym,0,4);
$m = substr($ym,5,2);

if( $m == "12" ){
	$ay = $y+1; 	$am = "1";
	$by = $y;  $bm = $m-1;
}else{
	if($m == "01" ){
		$by = $y - 1; $bm = "12";
	}else{
		$by = $y; $bm = $m -1 ;
	}
	$ay =  $y; $am = $m+1;
}

if( $bm < 10 ){
	$bm="0".$bm;
}
if( $am < 10 ){
	$am="0".$am;
}
$ad = $ay."-".$am;
$bd = $by."-".$bm;
#echo $bd;
#echo "<br/>".$ad."~".$bd;


$t = date("t", strtotime($ym."-01") );
$w = date("w", strtotime($ym."-01") );
$r = ceil(($t+$w)/7);
#echo "<br/>".ceil(( date("t", strtotime("2016-11-01") ) + date("w", strtotime("2016-11-01") ) )/7);

#echo $t."<br/>".$w."<br/>".$r;

include "../inc/dbConn.php";

?>
<center>
<input type="button" value="◀ 이전달" onclick="location.href='sm.html?ym=<?=$bd;?>';" />
&nbsp;&nbsp;
<font style="font-size:16pt;font-weight:bold;"><?=$y." 년 ".$m." 월";?></font>
&nbsp;&nbsp;
<input type="button" value="다음달 ▶"  onclick="location.href='sm.html?ym=<?=$ad;?>';" />
<br/>학생검진 예약 현황<br/> </font>
학생이름으로 조회 : <input type="text" id="hname" name="hname" value="" /> <button onclick="CK();">조회하기</button><br>
<script>
function CK( ){
	var nm=document.getElementById("hname").value;
	window.open("sm_w.html?nm="+nm,"","scrollbars=yes,width=700,height=500");
}
</script>
<style>

</style>
<table border='1'>
<tr align='center' class="ht">
<td class='red' >일</td>
<td>월</td>
<td>화</td>
<td>수</td>
<td>목</td>
<td>금</td>
<td class="blue">토</td>
</tr>
<?
$d = 1;
for($c = 1 ; $c <= $r ; $c++){
	echo "<tr style='font-size:13px;'  valign='top'>";
	for($i = 0 ; $i < 7 ; $i++ ){
		if( $i==0 ){ 
			$st = " class='red' "; 
		}elseif( $i==6 ){
			$st = " class='blue' "; 
		}else{
			$st = "  ";
		}
		
		if( $d < 10 ){ $td = "0".$d; }else{ $td = $d; }

		if( $c == 1){ #첫주일때
			if( $i < $w ){
				echo "<td>&nbsp;</td>";
			}else{
				$gtext = get_info( $y."-".$m."-".$td );
				if( str_replace($st," ","") == ""){
					echo "<td ".$st." width='200'><b>".$d."</b><br/><font color=black>".$gtext."</font></td>";
				}else{
					echo "<td ".$st."><b>".$d."</b><br/><font color=black>".$gtext."</font></td>";
				}
				#	echo "<td ".$st."><b>".$d."</b><br/><font color=black>".$gtext."</font></td>";
				
				$d++;
			}
		}elseif( $c == $r){ #마지막주일때
			if ( $d <= $t ){
				$gtext = get_info( $y."-".$m."-".$td );
				if( str_replace($st," ","") == ""){
					echo "<td ".$st." width='200'><b>".$d."</b><br/><font color=black>".$gtext."</font></td>";
				}else{
					echo "<td ".$st."><b>".$d."</b><br/><font color=black>".$gtext."</font></td>";
				}
				#echo "<td ".$st."><b>".$d."</b><br/><font color=black>".$gtext."</font></td>";
				
				$d++;
			}else{
				echo "<td>&nbsp;</td>";
			}
		}else{
			$gtext = get_info( $y."-".$m."-".$td );
			if( str_replace($st," ","") == ""){
				echo "<td ".$st." width='200'><b>".$d."</b><br/><font color=black>".$gtext."</font></td>";
			}else{
				echo "<td ".$st."><b>".$d."</b><br/><font color=black>".$gtext."</font></td>";
			}
			$d++;
		}
	}
	echo "</tr>";
}

?>
</table>
</center>

<script>

function RbusReg( dt ){
	window.open( "rbusreg.php?dt="+dt, "", "width=620 height=350" );
	//alert( dt );
}

function Mody( dt, val  ){
	window.open( "rbusreg.php?dt="+dt+"&val="+val, "", "width=620 height=350" );
	//alert( dt );
}

function Del( val ){
	//alert( val );
	window.open( "rbuspost.php?md=d&val="+val, "", "width=620 height=350" );
}
</script>

<?

function get_info( $val2 ){
	$tc = "";
	$sql = " SELECT RTIME, HNAME, COUNT(*) CNT FROM smart_r_student
				WHERE RDATE='".$val2."' AND SNAME not like '%".iconv("euc-kr","utf8","학생")."%'
				GROUP BY RTIME, HNAME
				ORDER BY 1 ";
	#echo $sql;
	if ( $result = mysql_query($sql) ){
		$tcnt = 0;
		while( $row = mysql_fetch_array($result) ){
			$tcnt += $row[CNT];
			$tc .= "<a onclick=\"show('$val2','$row[RTIME]');\">".$row[RTIME]." [ ".$row[CNT]." ]  ".iconv("utf8","euc-kr",$row[HNAME])."</a><br>";
		}
	}else{
		$tc = "&nbsp;";
	}
	return "총 예약 : ".$tcnt."명 <br>".$tc;
}

function wd( $st, $val2){
	global $gd, $od;
	include "../config/mysql_config.php";
	if( $st=="07:00" ){
		$ws = " '07:00', '7:00' ";
	}elseif( $st=="07:30" ){
		$ws = " '07:30', '7:30' ";
	}elseif( $st=="08:00" ){
		$ws = " '08:00', '8:00' ";
	}elseif( $st=="08:30" ){
		$ws = " '08:30', '8:30' ";
	}elseif( $st=="09:00" ){
		$ws = " '09:00', '9:00' ";
	}elseif( $st=="09:30" ){
		$ws = " '09:30', '9:30' ";
	#}elseif( $st=="11:00 ~" ){
	#	$ws = " '11:00', '11:30', '12:00', '12:30' ";
	#}elseif( $st=="14:30 ~" ){
	#	$ws = " '14:30', '15:00', '15:30', '16:00' ";
	}else{
		$ws = " '".$st."' ";
	}

	$msql = " select ifnull(sum( case when junggam='v' or gankang='v' then 1 else 0 end ),0) gd
							, ifnull(sum( case when ou='v' then 1 else 0 end ),0) od
							, ifnull(sum( case when ou='v' and ( junggam='v' or gankang='v' ) then 1 else 0 end ),0) p1
				from nesikyung_rev
				where rdate = '".$val2."'	and state='t' and sigan in ( ".$ws." ) ";
	#if( $val2=="2017-02-16" ){
	#	echo $msql."<br/>";
	#}
	if($reuslt2 = mysql_query($msql) ){
		$row2 = mysql_fetch_array($reuslt2);
		$ct = "[".($row2["gd"]-$row2["p1"])." / ".$row2["od"]."] ";
		$gd += $row2["gd"]-$row2["p1"];
		$od += $row2["od"];
	}else{
		$ct = "0";
	}

	return $ct;
}

function Stime($v, $val2){
	if( strtotime(date($val2)) < strtotime(date("2017-03-01")) ){
		if( $v == 1 ){ $vn = "08:00";
		}elseif( $v == 2 ){ $vn = "08:30";
		}elseif( $v == 3 ){ $vn = "09:00";
		}elseif( $v == 4 ){ $vn = "09:30";
		}elseif( $v == 5 ){ $vn = "10:00";
		}elseif( $v == 6 ){ $vn = "10:30";
		}elseif( $v == 7 ){ $vn = "11:00";
		}elseif( $v == 8 ){ $vn = "11:30";
		}elseif( $v == 9 ){ $vn = "12:00";
		}elseif( $v == 10 ){ $vn = "12:30";
		}elseif( $v == 11 ){ $vn = "14:00";
		}elseif( $v == 12 ){ $vn = "14:30";
		}elseif( $v == 13 ){ $vn = "15:00";
		}elseif( $v == 14 ){ $vn = "15:30";
		}elseif( $v == 15 ){ $vn = "16:00";
		}elseif( $v == 16 ){ $vn = "16:30";
		}
	}else{
		if( $v == 1 ){ $vn = "07:00";
		}elseif( $v == 2 ){ $vn = "07:30";
		}elseif( $v == 3 ){ $vn = "08:00";
		}elseif( $v == 4 ){ $vn = "08:30";
		}elseif( $v == 5 ){ $vn = "09:00";
		}elseif( $v == 6 ){ $vn = "09:30";
		}elseif( $v == 7 ){ $vn = "10:00";
		}elseif( $v == 8 ){ $vn = "10:30";
		}elseif( $v == 9 ){ $vn = "11:00";
		}elseif( $v == 10 ){ $vn = "11:30";
		}elseif( $v == 11 ){ $vn = "12:00";
		}elseif( $v == 12 ){ $vn = "12:30";
		}elseif( $v == 13 ){ $vn = "14:00";
		}elseif( $v == 14 ){ $vn = "14:30";
		}elseif( $v == 15 ){ $vn = "15:00";
		}elseif( $v == 16 ){ $vn = "15:30";
		}elseif( $v == 17 ){ $vn = "16:00";
		}elseif( $v == 18 ){ $vn = "16:30";
		}
	}
	return $vn;
}

?>

<iframe id="ifrm" name="ifrm" src="" style="display:none;"></iframe>
<script>
function show( d, t){
	window.open( "sm_d.html?d="+d+"&t="+t,"", "scrollbars=yes,width=700,height=700" );
	//document.getElementById("ifrm").src = "sm_d.html?d="+d+"&t="+t;
	//alert( document.getElementById("ifrm").src);
	//alert( d + " " + t );
}
</script>