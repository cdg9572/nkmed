<style>
.ht {
	font-weight : bold;
}

.blue{
	color: blue;
}

.red{
	color: red;
}
</style>
<style>
.tbl2	{	border:1px solid #d7d7d7; border-radius:1px; padding:6px;	}
.tbl2 td{	border-bottom:1px solid #d7d7d7; }
.tbl2 td input{	border-bottom:1px solid #d7d7d7; padding:5px;}
textarea { border:1px solid #d7d7d7; border-radius:5px; padding:6px; }
input { border:1px solid #d7d7d7; border-radius:5px; padding:6px; }
</style>
<title>예방접종 예약 월 현황</title>
<?

#echo "달력만들기";
global $gd, $od, $dat,$mw,$md, $trc;
global $ta,$tg,$ts,$th, $ty,$tz, $tw, $td, $tmr, $tee;
include "../inc/dbConn.php";
$dat = array();
if( $_GET["ym"]=="" ){ $ym = substr(date("Y-m-d"),0,7); }else{	$ym=$_GET["ym"];	}
#echo $ym;
$y = substr($ym,0,4);
$m = substr($ym,5,2);

if( $m == "12" ){
	$ay = $y+1; 	$am = "1";
	$by = $y;  $bm = $m-1;
}else{
	if($m == "01" ){
		$by = $y - 1; $bm = "12";
	}else{
		$by = $y; $bm = $m -1 ;
	}
	$ay =  $y; $am = $m+1;
}

if( $bm < 10 ){
	$bm="0".$bm;
}
if( $am < 10 ){
	$am="0".$am;
}
$ad = $ay."-".$am;
$bd = $by."-".$bm;
#echo $bd;
#echo "<br/>".$ad."~".$bd;


$t = date("t", strtotime($ym."-01") );
$w = date("w", strtotime($ym."-01") );
$r = ceil(($t+$w)/7);
#echo "<br/>".ceil(( date("t", strtotime("2016-11-01") ) + date("w", strtotime("2016-11-01") ) )/7);

#echo $t."<br/>".$w."<br/>".$r;

?>

<center>
<input type="button" value="◀ 이전달" onclick="location.href='ir_s.html?ym=<?=$bd;?>';" />
&nbsp;&nbsp;
<font style="font-size:16pt;font-weight:bold;"><?=$y." 년 ".$m." 월";?></font>
&nbsp;&nbsp;
<input type="button" value="다음달 ▶"  onclick="location.href='ir_s.html?ym=<?=$ad;?>';" />
<input type="button" value="재조회" onclick="location.reload();"/>
<br>접종 예약 현황<br>
<table border='0' width="1050" cellspacing='2'>
<tr align='center' class="ht">
<td class='red' width='150' >일</td>
<td width='150'>월</td>
<td width='150'>화</td>
<td width='150'>수</td>
<td width='150'>목</td>
<td width='150'>금</td>
<td class="blue" width='150'>토</td>
</tr>
<?
$d = 1;
for($c = 1 ; $c <= $r ; $c++){
	echo "<tr style='font-size:13px;'>";
	for($i = 0 ; $i < 7 ; $i++ ){
		if( $i==0 ){ 
			$st = " class='red' "; 
		}elseif( $i==6 ){
			$st = " class='blue' "; 
		}else{
			$st = "  "; 
		}
		
		if( $d < 10 ){ $td = "0".$d; }else{ $td = $d; }

		if( $c == 1){ #첫주일때
			if( $i < $w ){
				echo "<td>&nbsp;</td>";
			}else{
				if( strtotime(date($y."-".$m."-".$td)) >= strtotime(date("Y-m-d")) ){
					$gtext = get_info( $y.$m.$td, $y."-".$m."-".$td );
				#	$wdmcnt = "예약 $trc 명 &nbsp;오전 위:".$mw." &nbsp;대장:".$md;
				}else{
						$gtext = ""; $wdmcnt = "";
				}
				echo "<td ".$st." valign='top' style='background-color:#F6F6F6;'><b>".$d." &nbsp; </b><font color=black>$wdmcnt</font><br/><font color=black>".$gtext."</font></td>";
				$d++;
			}
		}elseif( $c == $r){ #마지막주일때
			if ( $d <= $t ){
				if( strtotime(date($y."-".$m."-".$td)) >= strtotime(date("Y-m-d")) ){
						$gtext = get_info( $y.$m.$td, $y."-".$m."-".$td );
				#		$wdmcnt = "예약 $trc 명 &nbsp;오전 위:".$mw." &nbsp; 대장:".$md;
				}else{
						$gtext = ""; $wdmcnt = "";
				}
				echo "<td ".$st." valign='top' style='background-color:#F6F6F6;'><b>".$d." &nbsp; </b><font color=black>$wdmcnt</font><br/><font color=black>".$gtext."</font></td>";
				$d++;
			}else{
				echo "<td>&nbsp;</td>";
			}
		}else{
			if( strtotime(date($y."-".$m."-".$td)) >= strtotime(date("Y-m-d")) ){
					$gtext = get_info( $y.$m.$td, $y."-".$m."-".$td );
					#$wdmcnt = "예약 $trc 명 &nbsp;오전 위:".$mw." &nbsp;대장:".$md;
			}else{
					$gtext = ""; $wdmcnt = "";
			}
			echo "<td ".$st." valign='top' style='background-color:#F6F6F6;'><b>".$d++." &nbsp; </b><font color=black>$wdmcnt</font><br/><font color=black>".$gtext."</font></td>";
		}
	}
	echo "</tr>";
}

?>
</table>
</center>



<?
function get_info( $val, $val2 ){
	global $gd, $od, $dat,$trc; 
	global $ta,$tg,$ts,$th, $ty,$tz, $tw, $td, $tmr, $tee;
	$gd=0; $od=0; $ta=0; $tg=0; $ts=0; $th=0; $tz=0; $trc=0; $ty=0; $tg2=0;

	$tc = "";
	$sql = "	SELECT rtime
			, COUNT(*) CNT
			FROM smart_ir 
			WHERE IDATE='$val2' AND sname<>''
			GROUP BY rtime
			ORDER BY rtime  ";

	if(	$r = mysql_query($sql) ){
		$tc = " <table border='1' cellspacing='0' style='font-size:9pt;'> ";
		$tc .= "<tr><td>시간대</td><td>건수</td></tr>";
		$tcnt = 0;
		while($row = mysql_fetch_array($r)){ 	
			$tcnt += $row[CNT];
			if( $row[rtime] == "" ){	$rt = "미지정"; }else{	$rt=$row[rtime];	}
			$tc .= "  <tr align='center'><td>".trim($rt)."</td>
							<td>$row[CNT]</td></tr>";			
		}
		$tc .= "<tr align='center'><td>합계</td><td>$tcnt</tr></tr>";
		$tc .= " </table> ";
	}

	return $tc;
}


?>
