<?
session_start();
include "../inc/dbConn.php";
include  "../inc/func.php";
$tbl = "smart_reserve";
header("Content-Type:text/html;charset=utf-8") ;

mysql_query("set names utf8;");


//==== register_global 처리
@extract($_GET);
@extract($_POST);
@extract($_SERVER);
@extract($_FILES);
@extract($_ENV);
@extract($_COOKIE);
@extract($_SESSION);


//$secret = "Y";
$subject = addslashes($subject);
$content = addslashes($content);
$comment = addslashes($comment);

//echo $sess_userid;
//exit;


unset($_SESSION["exam_category_il"]);
unset($_SESSION["exam_category_am"]);
unset($_SESSION["item_category"]);
unset($_SESSION["item_sex"]);
unset($_SESSION["mobile_no"]);
unset($_SESSION["name"]);
unset($_SESSION["reserve_seq"]);

testing_dsp("test post") ;
testing_dsp("post") ;
//testing_dsp("$_POST[exam_category_am] => 5대암 ") ;



testing_dsp($exam_category_am) ;

//if($_SERVER['REMOTE_ADDR'] == '122.45.143.21')
//{
	$password = trim($password);
	$mobile_no = trim($mobile_no);
	$birth = trim($birth);

	$content = str_replace("upload/","/SE2/upload/",$content);
	$content = htmlspecialchars_decode($content);
	$content = stripslashes($content);

// testing_dsp($exam_category_am) ;


	$_SESSION[exam_category_il] = $exam_category_il ;
	$_SESSION[exam_category_am] = $_POST[exam_category_am] ;
	$_SESSION[item_category] = $item_category ;
	$_SESSION[name] = $name ;
	$_SESSION[mobile_no] = $mobile_no ;
	

	if(strpos($item_category, "여") )
	{
		$_SESSION[item_sex] = "여" ;
	}
	else if(strpos($item_category, "남") )
	{
		$_SESSION[item_sex] = "남" ;
	}

	testing_dsp("session") ;

	//exit;
//}





//$content = str_replace("/SE2//SE2/","/SE2/",$content);


if($sess_userid == "" || $sess_username == ""){
	//echo "<script language='JavaScript'>alert('죄송합니다. 세션이 종료되어서 다시 로그인 후 이용하시기 바랍니다.'); history.go(-1);</script>";
	//exit;
}

if($mode == "new" || $mode == "write") {

	$state_flag = "예약대기" ;
	
	$sql = "
		INSERT INTO `smart_reserve`
            (
 			 `asp_name`,
             `subject`,
             `content`,
             `exam_category`,
			 `exam_category_il`,
			 `exam_category_am`,
             `item_category`,
             `item_seq`,
             `reserve_date`,
             `reserve_hour`,
             `reserve_min`,
             `name`,
             `mobile_no`,
             `admin_comment`,
             `mobileSMS_check`,
             `location`,
             `birth`,
             `password`,
             `state_flag`,
             `toUserComment`,
             `file1`,
             `file_name1`,
             `file2`,
             `file_name2`,
             `hit`,
             `reg_date`,
             `reg_id`,
             `reg_name`,
             `view_state`,
             `state`,
             `use_yn`,
             `text_type`)
		VALUES (
				'$sess_ASP_name',
				'$subject',
				'$content',
				'$exam_category',
				'$exam_category_il',
				'$exam_category_am',
				'$item_category',
				'$item_seq',
				'$reserve_date',
				'$reserve_hour',
				'$reserve_min',
				'$name',
				'$mobile_no',
				'$admin_comment',
				'$mobileSMS_check',
				'$location',
				'$birth',
				'$password',
				'$state_flag',
				'$toUserComment',
				'$file1',
				'$file_name1',
				'$file2',
				'$file_name2',
				'$hit',
				NOW(),
				'$reg_id',
				'$reg_name',
				'Y',
				'Y',
				'Y',
				'$text_type');
		
	";


	mysql_query($sql) ;

	$newSeq = mysql_insert_id();

	testing_dsp("[$newSeq] $sql") ;


	$_SESSION[reserve_seq] = $newSeq ;

	
//exit;

	if(!$newSeq) {
		MYSQL_CLOSE();
		echo "<script language='JavaScript'>alert('알 수 없는 오류로 정상적으로 처리되지 못했습니다.'); history.go(-1);</script>";
		exit;
	}
	else {
		/*$reserve_hour : $reserve_min*/
		if( $mobile_no <> "" && $_POST[name]<>"테스트"  ){
			$smsf_phone = $mobile_no;
			$smsf_msg = "$_POST[name] 님 $item_category 검진 $reserve_date  에 등록되었습니다. 전문상담원이 연락 드릴예정입니다." ;
			$smsf_opt1 = "seq=".$newSeq ;
			$frm="from1"; $ifrm="ifrm1"; $reyn = "N"; //리턴여부
			include "../inc/nksms.html" ;
		}

		//검진담당자에게 문자 발송
		if( $_POST[mobile_no] <> "" && $_POST[name]<>"테스트" && $_POST[mobile_no] <> "010-8837-3441"  ){
			$smsf_phone = "01050366850"; #손민정
			$smsf_msg = "$_POST[name] 님 $_POST[mobile_no] $item_category 검진 $reserve_date  에 예약등록되었습니다. " ;

			$smsf_opt1 = "seq=".$newSeq ;
			$frm="from2"; $ifrm="ifrm2"; $reyn = "Y"; //리턴여부
			include "../inc/nksms.html" ;
		}

		MYSQL_CLOSE();
		#echo "<script language='JavaScript'>alert('예약 되었습니다.');</script>";
		#echo "<script language='JavaScript'>parent.location.href='./reserveResult.html?seq=$newSeq'</script>";
	

		exit;
	}
}
else if($mode == "modify" && $seq) {


	if($tbl == "t_free"){
		$que = MYSQL_QUERY("SELECT reg_id FROM ".$tbl." WHERE seq='".$seq."' AND reg_id='".$sess_userid."'");
	}
	else{
		$que = MYSQL_QUERY("SELECT user_id FROM ".$tbl." WHERE seq='".$seq."' AND user_id='".$sess_userid."'");
	}

	if(!$row = MYSQL_FETCH_ARRAY($que)) {
		echo "<script language='JavaScript'>alert('수정 권한이 없습니다.'); history.go(-1);</script>";
		exit;
	}

	if(!$subject) {
		echo "<script language='JavaScript'>alert('제목을 입력해 주세요.'); history.go(-1);</script>";
		exit;
	}

	if(!$content) {
		echo "<script language='JavaScript'>alert('내용을 입력해 주세요.'); history.go(-1);</script>";
		exit;
	}

	if($tbl == "t_qna"){
		MYSQL_QUERY("UPDATE ".$tbl." SET category='".$category."', course_code='".$course_code."', course_name='".$course_name."', subject='".$subject."', content='".$content."', secret='".$secret."',reserve_date='".$STUDY_SDATE_A."',reserve_time='".$stime."' WHERE seq='".$seq."' AND user_id='".$sess_userid."'");
	}
	else if($tbl == "t_review"){
		MYSQL_QUERY("UPDATE ".$tbl." SET subject='".$subject."', content='".$content."' WHERE seq='".$seq."' AND reg_id='".$sess_userid."'");
	}
	else{

		MYSQL_QUERY("UPDATE ".$tbl." SET category='".$category."', course_code='".$course_code."', course_name='".$course_name."', subject='".$subject."', content='".$content."', secret='".$secret."' WHERE seq='".$seq."' AND user_id='".$sess_userid."'");
	}
	MYSQL_CLOSE();
	echo "<script language='JavaScript'>alert('수정 되었습니다.');</script>";
	echo "<script language='JavaScript'>document.location.href='".$return_pages."?mode=list&tbl=".$tbl."&course_code=".$course_code."&field=".$field."&keyword=".$keyword."&pageNum=".$pageNum."'</script>";
	exit;
}
else if($mode == "answer" && $seq && $user_class == "PROF") {
	

	if(!$answer) {
		echo "<script language='JavaScript'>alert('답변을 입력해 주세요.'); history.go(-1);</script>";
		exit;
	}

	MYSQL_QUERY("UPDATE ".$tbl." SET answer='".$answer."', answer_date=now(), user_id='".$sess_userid."' WHERE seq='".$seq."'");
	MYSQL_CLOSE();

	echo "<script language='JavaScript'>document.location.href='".$return_pages."?mode=list&tbl=".$tbl."&course_code=".$course_code."&field=".$field."&keyword=".$keyword."&pageNum=".$pageNum."'</script>";
	exit;
}
else if($mode == "del" && $seq) {
	$que = MYSQL_QUERY("SELECT user_id FROM ".$tbl." WHERE seq='".$seq."' AND user_id='".$sess_userid."'");

	if(!$row = MYSQL_FETCH_ARRAY($que)) {
		echo "<script language='JavaScript'>alert('삭제 권한이 없습니다.'); history.go(-1);</script>";
		exit;
	}

	MYSQL_QUERY("UPDATE ".$tbl." SET view_state='N' WHERE seq='".$seq."' AND user_id='".$sess_userid."'");
	MYSQL_CLOSE();

	echo "<script language='JavaScript'>document.location.href='".$return_pages."?mode=list&tbl=".$tbl."&course_code=".$course_code."&field=".$field."&keyword=".$keyword."&pageNum=".$pageNum."'</script>";
	exit;
}
else if($mode == "comment" && $seq) {
	if(!$comment) {
		echo "<script language='JavaScript'>alert('코멘트를 작성해 주세요.'); history.go(-1);</script>";
		exit;
	}

	MYSQL_QUERY("INSERT INTO community_free_comment(org_seq, content, reg_date, user_id, user_name) VALUES('".$seq."', '".$comment."', NOW(), '".$sess_userid."', '".$sess_username."')");

	echo "<script language='JavaScript'>document.location.href='".$return_pages."?mode=list&tbl=".$tbl."&seq=".$seq."&course_code=".$course_code."'</script>";
	exit;
}
else if($mode == "commDel" && $commSeq){
	$que = MYSQL_QUERY("SELECT * FROM community_free_comment WHERE seq='".$commSeq."' AND user_id='".$sess_userid."'");
	if(!$row = MYSQL_FETCH_ARRAY($que)) {
		echo "<script language='JavaScript'>alert('삭제권한이 없습니다.'); history.go(-1);</script>";
		exit;
	}

	MYSQL_QUERY("UPDATE community_free_comment SET view_state='N' WHERE seq='".$commSeq."' AND user_id='".$sess_userid."'");

	echo "<script language='JavaScript'>document.location.href='".$return_pages."?mode=list&tbl=".$tbl."&seq=".$seq."&course_code=".$course_code."'</script>";
	exit;
}
?>