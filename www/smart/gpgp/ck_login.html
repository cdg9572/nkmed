<?
session_start();

header("Content-Type:text/html;charset=utf-8");

ini_set("display_errors", 1);
error_reporting(E_ALL ^ E_NOTICE);

include "./inc/func.php";
include "./inc/dbConn.php";


testing_dsp("post");
testing_dsp("session");

//============= 로그아웃 처리 
if($mode == "D" OR $_GET[mode]=="D") {

	session_destroy();
	echo "<script language='JavaScript'>location.href='ck_login.html'</script>";
	exit;


}

if($_POST[mode] == "login") {

	if($name == "11111")
	{
		$name = "홍길동" ;
		$mobile_right = "1111" ;
	}

	else if($name == "22222")
	{
		$name = "심청이" ;
		$mobile_right = "2222" ;
	}

	else if($name == "33333")
	{
		$name = "성명" ;
		$mobile_right = "3333" ;
	}


	$sql ="select * from smart_ck 
					where cpname='김포시설관리공단' and pname='".$_POST[name]."' and replace( tel, '-', '' )='".$_POST[mobile_right]."'
						and use_yn='Y' order by reg_date desc" ;
	//echo $sql;
	//testing_dsp($sql);

	//exit;
	
	$que = MYSQL_QUERY($sql);
	$row = MYSQL_FETCH_ARRAY($que);



	if($row[pname] =="" || $row[cpname] == "") {
		echo "<script language='JavaScript'>alert('사용자 정보가 일치하지 않습니다.'); document.location.href='ck_login.html'</script>";
		exit;
	}else {
		
		$_SESSION['CK'] = "OK";
		$_SESSION['sess_UNAME'] = $row['pname'];
		$_SESSION['sess_UCATEGORY'] = $row['category'];
		$_SESSION['sess_USEX'] = $row['sex'];
		$_SESSION['sess_USEQ'] = $row['seq'];
		$_SESSION['sess_site'] = "user";

		$_SESSION['sess_item_data_seq'] = $row['seq'];



		echo "<script language='JavaScript'>document.location.href='./index.html'</script>";

	
	}

	MYSQL_CLOSE();
}

?>


<!doctype html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>뉴고려병원</title>
<link rel="stylesheet" type="text/css" href="../report/jquery-mobile/jquery.mobile.theme-1.4.5.min.css">
<link rel="stylesheet" type="text/css" href="../report/jquery-mobile/jquery.mobile.structure-1.4.5.css">
<link rel="stylesheet" type="text/css" href="../css/custom2.css">
<script src="../report/jquery-mobile/jquery-1.11.1.min.js" type="text/javascript"></script>
<script src="../report/js/sha1.js" type="text/javascript"></script>
<script src="../report/jquery-mobile/jquery.mobile-1.4.5.min.js" type="text/javascript"></script>

<style>
.ui-body-a,.ui-page-theme-a .ui-body-inherit,html .ui-bar-a .ui-body-inherit,html .ui-body-a .ui-body-inherit,html body .ui-group-theme-a .ui-body-inherit,html .ui-panel-page-container-a{background-color:#fff;border-color:#1389F0;color:#333;text-shadow:0 1px 0 #f3f3f3; -webkit-border-radius: 0 !important; -moz-border-radius: 0 !important; border-radius: 0 !important;}

.ui-page-theme-a .ui-btn:focus,html .ui-bar-a .ui-btn:focus,html .ui-body-a .ui-btn:focus,html body .ui-group-theme-a .ui-btn:focus,html head+body .ui-btn.ui-btn-a:focus,.ui-page-theme-a .ui-focus,html .ui-bar-a .ui-focus,html .ui-body-a .ui-focus,html body .ui-group-theme-a .ui-focus,html head+body .ui-btn-a.ui-focus,html head+body .ui-body-a.ui-focus{-webkit-box-shadow:0 0 5px #1389F0;-moz-box-shadow:0 0 5px #1389F0;box-shadow:0 0 5px #1389F0; }
</style>


<script language="JavaScript">
<!--
function Enter_Check()
{
     if(event.keyCode == 13)
     chkForm(document.LOGIN);
}

function chkForm(frm) {
	if(!frm.name.value) {
		alert('이름을 입력해 주세요.');
		frm.name.focus();
		return false;
	}
	
	else if(!frm.mobile_right.value) {
		alert('생년월일을 입력해 주세요.');
		frm.mobile_right.focus();
		return false;
	}
	else{
		//frm.submit();
	}
}
//-->
</script>

</head>

<body>
<div data-role="page" id="loginPage" style="">
	<div data-role="content" class="container">
	<br/><br/>
		<h1 class="login_title" style='padding-bottom:20px;'>
			<img src="../report/images/logo_big.png" width="300" alt="로그인로고"/>
			<span class="hidden">종합병원 뉴고려병원</span>
		</h1>
		<div class="loginBox" style="display:none;">
			<form method="post" name='LOGIN' action="" data-ajax="false">
				<input type=hidden name="mode" value="login">
					<input name="name" type="text" id="userNum" placeholder="이름을 입력해 주십시오." value="" />
					<input name="mobile_right" type="text" id="mobile_right" placeholder="핸드폰번호 4자리를 입력해 주십시오. ex:1234" value="" />
				
				<button type="submit" onClick="return chkForm(document.LOGIN)">LOGIN</button>
			</form>
		</div>
		<div class="ps_ment">
			<p>본 사이트는 개인 건강검진결과 리포트를 위한 사이트이며, 모바일 전용으로 만들어진 사이트 입니다.</p>
		</div>
		
		
			<form name="frm2" method="" action="" target=""  class="loginBox" >
				<input type="text" id="name1" value=""   placeholder="이름을 입력해 주십시오." />
				<input type="text" id="tel1" value=""  placeholder="핸드폰번호를 입력해 주십시오." />

				<input type="button" value="인증문자요청" onclick="CHK_SMS()" />
				<input type="text" id="tel_ck" value=""  placeholder="인증번호를 입력해 주십시오."  />
			
				<input type="hidden" id="tel2" value="" />
				<input type="hidden" id="cknum2" value="" />
				<!--<input type="button" value="LOGIN" onclick="CK()" />-->
				<input type="button" value="LOGIN" onclick=" return CNK(); " >
			</form>

			<div>
			<iframe id="sifrm" name="sifrm" src="" width="300" height="200" style="display:none;" ></iframe>
			
			<script>
			function CNK(){
				
				if( document.frm2.tel_ck.value == "" ){
					alert( "인증번호를 입력해주세요." );
					document.frm2.tel_ck.focus();
					return false;
				}else{
					//비교 
					if( hex_sha1( document.frm2.tel_ck.value  ) == document.frm2.cknum2.value ){
						//alert( "반응을 한다." );
						document.LOGIN.name.value = document.frm2.name1.value;
						//document.LOGIN.mobile_right.value = document.frm2.tel1.value.substr((document.frm2.tel1.value.length - 4),4);
						document.LOGIN.mobile_right.value = document.frm2.tel1.value.replace(/\-/gi,"");
						document.LOGIN.submit();
						//return false;
					}else{
						alert( "인증번호가 일치 하지 않습니다. 다시 시도 또는 새로 인증 요청 해주세요." );
						document.frm2.tel_ck.focus();
						return false;
					}
				}
				//alert( "검증 들어 갑니다." );
				return false;
			}

			function CHK_SMS(  ){ 
				Check_Num( document.frm2.tel1.value ); 
				if( document.frm2.name1.value==""){
					alert("성명을 입력해주세요.");
					document.frm2.name1.focus();
				}else{
					alert("인증번호를 요청하였습니다.");
					document.frm2.target="sifrm";
					document.getElementById("sifrm").src= "chksms.php?md=check&name1="+document.frm2.name1.value+"&tel2="+document.frm2.tel2.value;
				}
			}
			 
			function Check_Num( val ){
				val2 = val.replace(/\-/gi,"");
				document.getElementById("tel2").value=hex_sha1( val2  );
			}
			</script>
			</div>
	</div>
</div>

</body>
</html>