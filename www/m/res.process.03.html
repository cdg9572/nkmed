<?php
	include_once  '../_init.php';
	if (!$C_Func -> is_login()) {
        $C_Func -> put_msg_and_go ('로그인 해 주세요' , '/m/login.html?reurl=' . urlencode($GP -> NOWPAGE));
    }
    if ($_SESSION['suserphone'] == '' || $_SESSION['susername'] == '') {
        $C_Func -> put_msg_and_go('이름이나 휴대폰 정보가 없습니다. 정보를 기입한 후에 이용해 주세요.' , '/m/user.info.html');
    }        
    include_once $GP -> INC_WWW . '/m.head.php';
   	include_once($GP -> CLS."/class.doctor.php");	
   	//include_once($GP -> CLS."/class.mcc.php");	    
	$C_Doctor 	= new Doctor;
	//$C_Mcc	 	= new Mcc;    
	$args['dr_idx'] = $_GET['dr_idx'];
	$data = "";
	$data = $C_Doctor->Doctor_Info($args);    	
    extract($data);

    $url = "http://1.214.232.188:8070/api/v1/";
    $path01 = "view_dr";                                         
  

    $data01 = array(       
        "is_dept" => $dr_mtreat_no, //진료과코드
        "is_doct" =>  $dr_mcode//의사코드      
    );    
	    

    $json_data = json_encode($data01);
    $curl = curl_init();
    curl_setopt_array($curl, array(
    CURLOPT_URL => $url.$path01,
    CURLOPT_RETURNTRANSFER => true,
    CURLOPT_CUSTOMREQUEST => 'GET',
    CURLOPT_POSTFIELDS => $json_data,
    CURLOPT_HTTPHEADER => array(
        'Content-Type: application/json'),
    ));
    $response = curl_exec($curl);                  
    $data02 = json_decode($response, true);

    if( $data02['data_cnt'] < 1){          
        $C_Func->put_msg_and_back("해당 의료진은 예약이 불가 합니다.");			
    }



    $url = "http://1.214.232.188:8070/api/v1/";
    $path01 = "date_reserve";                                          

    $data01 = array(       
        "is_dept" => $dr_mtreat_no, //진료과코드
        "is_doct" =>  $dr_mcode,//의사코드      
        "is_month" => date("Ym")
    );      
    //현재년월
    


    $json_data = json_encode($data01);
    $curl = curl_init();
    curl_setopt_array($curl, array(
    CURLOPT_URL => $url.$path01,
    CURLOPT_RETURNTRANSFER => true,
    CURLOPT_CUSTOMREQUEST => 'GET',
    CURLOPT_POSTFIELDS => $json_data,
    CURLOPT_HTTPHEADER => array(
        'Content-Type: application/json'),
    ));
    $response = curl_exec($curl);                  
    $data02 = json_decode($response, true);

    //echo "data0101:<pre>"; print_r($data01); echo "</pre><br>" ;
    //echo "data0202:<pre>"; print_r($data02); echo "</pre><br>" ;
	//echo "data0202:<pre>"; print_r($data02["data"]); echo "</pre><br>" ;
    //exit;

    //if( $data02['data_cnt'] < 1){          
    //    $C_Func->put_msg_and_back("일치하는 의료진 정보가 존재하지 않습니다.");			
    //}

   
    $data03 = "";
    for	($i=0; $i<count($data02["data"]); $i++) {	        
        $today2 = date("Y-m-d", strtotime("+1 days"));        
        if (strtotime($data02["data"][$i]) <= strtotime($today2)) continue;

        $today = date("Y-m-d", strtotime("+3 months"));        
        if (strtotime($data02["data"][$i]) >= strtotime($today)) continue;

		if (date("w", strtotime($data02["data"][$i])) == 0) continue;

        $data03 .=  '"' .date("Y-m-d", strtotime($data02["data"][$i])) .'"' ;
        //마지막 만 빼고 , 붙이기
        if($i != count($data02["data"])-1) $data03 .= ",";	                
    }

	//echo "data:"; print_r($data03); echo "<br>" ;



    $dr_ps 			= $GP -> DOCTOR_POSITION[$dr_position];	
    $dr_cn 			= $GP -> CLINIC_TYPE1[$dr_clinic1];	
    $moning_arr 	= explode(',', $dr_m_sd);	
    $after_arr 		= explode(',', $dr_a_sd);
    if($_GET["ct_type"]){
        $c_type			= $GP->NEW_MOBILE_CENTER_ALL[$_GET["ct_type"]];
    }
    else{
        $cn_arr2 = explode(",", $dr_clinic2);
        foreach ($cn_arr2 as $key => $val) {
                $c_type .= $GP -> NEW_MOBILE_CENTER_ALL[$val] . ",";                  
        }
        $c_type = substr($c_type, 0, -1);    
    }
    
    $year = ($_GET["year"]) ? $_GET["year"] : date("Y");
    $pYear = $year - 1;
    $nYear = $year + 1;    
    
    $r_date 		= date("Y-n-d",strtotime("+2 days"));
    $date_arr		= explode("-",$r_date);
    $n_year			= $year;
    $n_month		= $date_arr[1];
    $n_day			= $date_arr[2];
    $s_month 		= ($n_year == $date_arr[0]) ? $date_arr[1] : 1;
    
    $process_type = $_GET['ptype'];
	$process_title = '';
	if ('s' == $process_type){
		$process_title = '본인예약';
	} else if ('g' == $process_type){
		$process_title = '보호자로 예약';
	}

	if($_GET["recept_no"]){
		$mode = "ONLINE_RESERVE_MODIFY";
	}
	else{
		$mode = "ONLINE_RESERVE_REG";
	}
   
?>
<link rel="stylesheet" type="text/css" href="/admin/css/jquery_ui.css" media="all" style="user-select: auto;">
<style>
    .ui-datepicker {
	width: 100%;
}
</style>
<body>
<div id="wrap">
	<div id="header">
		<div class="hgroup">
			<h1 class="page-title"><?php echo $process_title;?></h1>
			<a href="javascript:history.back(-1);" class="history-back"><i class="ip-icon-arrow-back"></i><span class="text-ir">이전 화면</span></a>
		</div>
		<? include_once $GP -> INC_WWW . '/m.header.php'; ?>
    </div>
	<div id="container" class="reserve-entry">
		<form id="r_form" name="r_form" class="body" action="?" method="post">
        	<input type="hidden" value="<?=$mode?>" id="mode" name="mode">
            <input type="hidden" value="<?=$dr_mcode?>" id="dr_mcode" name="dr_mcode">
            <input type="hidden" value="<?=$c_type?>" id="c_type" name="c_type">
            <input type="hidden" value="<?=$ptype?>" id="ptype" name="ptype">
            <input type="hidden" value="<?=$dr_name?>" id="dr_name" name="dr_name">
            <input type="hidden" value="<?=$dr_ps?>" id="dr_ps" name="dr_ps">
            <input type="hidden" value="<?=$_SESSION['suserphone']?>" id="tor_rs_phone" name="tor_rs_phone">
            <input type="hidden" value="<?=$tor_name?>" id="tor_name" name="tor_name">
            <input type="hidden" name="mb_code" id="mb_code" value="<?=$_SESSION['susercode']?>" />
            <input type="hidden" name="tor_rs_name" id="tor_rs_name" value="<?=$_SESSION['susername']?>" />
            <input type="hidden" name="dr_mcode" id="dr_mcode" value="<?=$dr_mcode?>" />
            <input type="hidden" name="dr_mtreat_no" id="dr_mtreat_no" value="<?=$dr_mtreat_no?>" />
            <input type="hidden" name="is_date" id="is_date"/>
            <input type="hidden" value="<?=$_GET["recept_no"]?>" id="recept_no" name="recept_no">
			<div class="doctor-selection-info">
				<dl class="header">
					<dt>예약선택</dt>
					<dd class="depart"><?=$c_type?></dd>
					<dd class="name"><?=$dr_name?> <?=$dr_ps?></dd>
				</dl>
				<div class="doctor-schedule">
					<table>
						<thead>
							<tr>
								<th scope=""></th>
								<th scope="row">월</th>
								<th scope="row">화</th>
								<th scope="row">수</th>
								<th scope="row">목</th>
								<th scope="row">금</th>
								<th scope="row">토</th>
							</tr>
						</thead>
						<tbody>
							<tr>
								<th scope="col">오전</th>
								<td><? if (in_array("월", $moning_arr)) { echo '<span class="open">진료</span>'; }else{ echo '<span class="void">-</span>'; }?></td>
                                <td><? if (in_array("화", $moning_arr)) { echo '<span class="open">진료</span>'; }else{ echo '<span class="void">-</span>'; }?></td>
                                <td><? if (in_array("수", $moning_arr)) { echo '<span class="open">진료</span>'; }else{ echo '<span class="void">-</span>'; }?></td>
                                <td><? if (in_array("목", $moning_arr)) { echo '<span class="open">진료</span>'; }else{ echo '<span class="void">-</span>'; }?></td>
                                <td><? if (in_array("금", $moning_arr)) { echo '<span class="open">진료</span>'; }else{ echo '<span class="void">-</span>'; }?></td>
                                <td><? if (in_array("토", $moning_arr)) { echo '<span class="open">진료</span>'; }else{ echo '<span class="void">-</span>'; }?></td>
							</tr>
							<tr>
								<th scope="col">오후</th>
								<td><? if (in_array("월", $after_arr)) { echo '<span class="open">진료</span>'; }else{ echo '<span class="void">-</span>'; }?></td>
                                <td><? if (in_array("화", $after_arr)) { echo '<span class="open">진료</span>'; }else{ echo '<span class="void">-</span>'; }?></td>
                                <td><? if (in_array("수", $after_arr)) { echo '<span class="open">진료</span>'; }else{ echo '<span class="void">-</span>'; }?></td>
                                <td><? if (in_array("목", $after_arr)) { echo '<span class="open">진료</span>'; }else{ echo '<span class="void">-</span>'; }?></td>
                                <td><? if (in_array("금", $after_arr)) { echo '<span class="open">진료</span>'; }else{ echo '<span class="void">-</span>'; }?></td>
                                <td><? if (in_array("토", $after_arr)) { echo '<span class="open">진료</span>'; }else{ echo '<span class="void">-</span>'; }?></td>
							</tr>
						</tbody>
					</table>
				</div>
			</div>
			<div class="schedule-selection">
            <div id="online_date"></div>                 
				<!-- <div class="date-selection">
					<div class="year-section">
						<input type="text" name="year" id="year" class="i-year" readonly value="<?=$n_year?>" />
						<a href="?dr_idx=<?=$dr_idx?>&ptype=<?=$ptype?>&year=<?=$pYear?>" class="prev-year"><i class="ip-icon-prev"></i><span class="text-ir">이전 해</span></a>
						<a href="?dr_idx=<?=$dr_idx?>&ptype=<?=$ptype?>&year=<?=$nYear?>" class="next-year"><i class="ip-icon-next"></i><span class="text-ir">다음 해</span></a>
					</div>
					<div class="detail-section">
						<select name="month" id="month" class="i-text">
							<option value="">월 선택</option>
                            <?
                             for($i=$s_month;$i<=12;$i++){
                                echo "<option value='".sprintf('%02d',$i)."'>".$i."월";
                            }
                            ?>
						</select>
						<select name="day" id="day" class="i-text">
							<option value="">일 선택</option>
						</select>
					</div>
				</div> -->
			<!--<div class="date-schedule" id="day_result">
					<예약날짜 선택 안 한 경우 >
					<p>예약날짜를 선택하세요.</p>					
					<dl>
						<dt class="text-ir">진료시간</dt><dd>09:30 ~ 05:30</dd>
						<dt class="text-ir">예약가능 여부</dt><dd>
							<span class="enable">예약가능</span>
							<span class="disable">예약불가</span>
							<span class="closed">휴진</span>
						</dd>
					</dl>                    
				</div> -->
				<dl class="time-selection">
					<dt>희망 진료시간 선택</dt>
					<dd><select name="time" id="time" class="i-text">
						<option value="">진료시간 선택</option>
					</select></dd>
				</dl>
                <dl class="time-selection">
					<dt>메모</dt>
					<dd>
                        <!-- textarea 높이 설정 -->
                        <textarea name="comt" id="comt" class="i-text" style="width:100%;height:50px;"></textarea>
                    </dd>
				</dl>
				<dl class="time-selection">
					해당 예약은 본인 예약만 가능합니다.				
				</dl>
				<button type="submit" id="img_submit" class="next-step">진료 예약하기</button>
			</div>
		</form>
	</div>
	<div id="footer">
		<p class="copyright">
			<span>Copyright(c) 2019</span>
			<em>NEW Korea Hospital</em>
		</p>
		<hr class="v-line" />
		<a href="https://www.nkhospital.net/" target="_blank">홈페이지 바로가기</a>
	</div>
</div>
</body>
</html>

<script>
var dr_mcode = "<?=$dr_mcode?>";
var dr_name  = "[<?=$c_type?>]<?=$dr_name?> <?=$dr_ps?>";
var vrday = "";	

//현재달
var now = new Date();
var nowMonth = now.getMonth() + 1;

callDatePick('online_date');

function callDatePick(id) {
    // 특정 날짜 배열 생성
    var enabledDates = [<?=$data03?>];

    var dates = $("#" + id).datepicker({
        beforeShowDay: function(date) {
            var string = $.datepicker.formatDate('yy-mm-dd', date);
            return [enabledDates.indexOf(string) != -1];
        },
        onSelect: function(dateText, inst) {
        // 날짜 선택시 실행할 코드                 
                time_sel('<?=$dr_mtreat_no?>','<?=$dr_mcode?>',dateText);             
        },
        onChangeMonthYear: function(year, month, inst) {  
    
            //현재달 구하기
            // var r_date = new Date();
            // var m_month = r_date.getMonth() + 1;
             var month2 = month.toString().padStart(2, '0');
             var is_month = year + month2;          
             window.location.href = "/m/res.process.03_next.html?dr_idx=<?=$dr_idx?>&ct_type=<?=$_GET["ct_type"]?>&dr_mtreat_no=<?=$dr_mtreat_no?>&dr_mcode=<?=$dr_mcode?>&recept_no=<?=$_GET["recept_no"]?>&is_month="+is_month;     
            // if (m_month > month) {  //현재달이 클릭한 달보다 크면 = 다음달 클릭
            //     var datecheck = "prev";               
            // } else if (m_month < month) { //현재달이 클릭한 달보다 작으면        
            //     var datecheck = "next";               
            // }                
            // ch_cal('<?=$dr_mtreat_no?>','<?=$dr_mcode?>',is_month,month,datecheck);                     
            //console.log( m_month + " / " + month + " / " +  datecheck );
                          
                      
        },
        prevText: '이전 달',
        nextText: '다음 달',
        monthNames: ['1월', '2월', '3월', '4월', '5월', '6월', '7월', '8월', '9월', '10월', '11월', '12월'],
        monthNamesShort: ['1월', '2월', '3월', '4월', '5월', '6월', '7월', '8월', '9월', '10월', '11월', '12월'],
        dayNames: ['일', '월', '화', '수', '목', '금', '토'],
        dayNamesShort: ['일', '월', '화', '수', '목', '금', '토'],
        dayNamesMin: ['일', '월', '화', '수', '목', '금', '토'],
        dateFormat: 'yy-mm-dd',
        showMonthAfterYear: true,
        yearSuffix: '년'
    });
}  

function ch_cal(dr_mtreat_no, dr_mcode, is_month,month,datecheck) {     
   // console.log(dr_mtreat_no + " / " + dr_mcode + " / " + is_month + " / " + month + " / " + datecheck); 
    if(datecheck == "next"){ 
        var monthhap = parseInt(month)-1;        
    }else if(datecheck == "prev"){      
        var monthhap = parseInt(month)+1;        
    }    

    console.log( datecheck + " / " + monthhap + " / " +  month );
 
    $.ajax({
            type: "POST",
            url: "day_ajax_change.php",
            data:{
            "dr_mtreat_no"	: dr_mtreat_no,
            "dr_mcode": dr_mcode,
            "month": month,
            "is_month": is_month
            },
            dataType: "text",
            success: function (data) {
                console.log(data);
                //  $("#online_date"+monthhap).empty();
                //  $("#online_date"+month).append(data);                   
                 $('#online_date').empty();
				 $('#online_date').append(data);      
               
            },
            error: function (xhr, status, error) {
                alert(error);
            }
        });		
    }
	//$("#day").change(function(){	
    function time_sel(dr_idx, date, dateText) {				
		var dr_idx = "<?=$dr_idx?>";
        var dr_mcode = "<?=$dr_mcode?>";
        var dr_mtreat_no = "<?=$dr_mtreat_no?>";
		var html = "";     

        //dateText 숫자만 추출
        var dateText = dateText.replace(/[^0-9]/g,'');

        $("#is_date").val(dateText);
       
		$.ajax({
            type: "POST",
            url: "day_ajax_change.php",
            data:{
            "nday"	: dateText,
            "dr_idx": dr_idx,
            "dr_mcode": dr_mcode,
            "dr_mtreat_no": dr_mtreat_no,
            "mode"	: "T"
            },
            dataType: "text",
            beforeSend: function() {
                //$('#ajax_load').html('<img src="/images/ajax-loader.gif">');
            },
            success: function(data) {
                console.log(data);
                html += '<option value="">진료시간 선택</option>';
                html += data;
                $("#time").empty().append(html);
            },
            error: function(xhr, status, error) { alert(error); }
        });		
	//});
    };

    
	$(document).on('change', '#time', function(){
		var rday = $('#day').val();
		var rtime = $(this).val();
		vrday = rday.substr(0,4)+"년"+rday.substr(4,2)+"월"+rday.substr(6,2)+"일 "+rtime.substr(0,2)+"시"+rtime.substr(2,2)+"분";
		$("#day_result").empty().append("<span class='enable'>"+dr_name+" 예약일 : "+vrday+"</span>"); 	
      
	});		  
    
    

    function disableButton() {
      var button = $('#img_submit');
      button.prop('disabled', true);
     // button.hide(); // 버튼을 숨깁니다.
	 button.text('처리중이니 잠시 기다려 주세요'); // 버튼 텍스트 변경	 
    }	
	
	$('#img_submit').click(function(){        

		if($('#month option:selected').val() == '')	{
			alert('월 선택을 해주세요.');
			return false;
		}
		
		if($('#day option:selected').val() == '')	{
			alert('일 선택을 해주세요.');
			return false;
		}
		
		
		if($('#time option:selected').val() == '')	{
			alert('진료시간을 선택을 해주세요.');
			return false;
		}

        disableButton();		

		$('#r_form').attr('action','proc/online_proc.php');
		$('#r_form').submit();
		return false;

	});

	
    // $("#month").change(function(){		
	// 	var year = $('#year').val();
	// 	var month = $(this).val();
	// 	var html = "";
	// 	$.ajax({
	// 		type: "POST",
	// 		url: "day_ajax_change.php",
	// 		data:{
	// 		"year"	: year,
	// 		"month" : month
	// 		},
	// 		dataType: "text",
	// 		beforeSend: function() {
	// 			//$('#ajax_load').html('<img src="/images/ajax-loader.gif">');
	// 		},
	// 		success: function(data) {
	// 			console.log(data);
	// 			html += '<option value="">일 선택</option>';
	// 			html += data;				
	// 			$("#day").empty().append(html);

	// 		},
	// 		error: function(xhr, status, error) { alert(error); }
	// 	});		
	// });
</script>



