<?php
	include_once  '../_init.php';
	include_once($GP -> CLS."/class.online.php");	    
	include_once($GP -> CLS."/class.doctor.php");	        
   	//include_once($GP -> CLS."/class.mcc.php");	    
	//$C_Mcc	 	= new Mcc;        
    $C_Online 	= new Online;
    $C_Doctor 	= new Doctor;        
    
	include_once $GP -> INC_WWW . '/m.head.php';
    if (!$C_Func -> is_login()) {
        $C_Func -> put_msg_and_go ('로그인 해 주세요' , '/m/login.html?reurl=' . urlencode($GP -> NOWPAGE));
    }
//  $args["mb_id"] = $_SESSION["suserid"];

    $args["name"] = $_SESSION["susername"];
    $args["name"] = $_SESSION["susername"];
    $args["PROC_GB"] = "00";    
    
    $args["phone"] = str_replace("-","",$_SESSION["suserphone"]);

    //$data = $C_Mcc->RevInfo($args);
    //print_r($data);

	//고객번호 조회하기
     $url = "http://1.214.232.188:8070/api/v1/";
     $path01 = "exp_patient";   
     
     $data01 = array(
         "cust_name" =>  $_SESSION['susername'],
         "cust_phone" => str_replace("-", "",$_SESSION['suserphone'])
     );

    
     $json_data = json_encode($data01);
     $curl = curl_init();
     curl_setopt_array($curl, array(
     CURLOPT_URL => $url.$path01,
     CURLOPT_RETURNTRANSFER => true,
     CURLOPT_CUSTOMREQUEST => 'GET',
     CURLOPT_POSTFIELDS => $json_data,
     CURLOPT_HTTPHEADER => array(
         'Content-Type: application/json'),
     ));
     $response = curl_exec($curl);                  
     $data = json_decode($response, true);	   

     $_SESSION['suserbirth'] 	= $data['data'][0]['cust_birth'];
     $_SESSION['suserpatientno'] 	= $data['data'][0]['cust_no'];
     $_SESSION['susercount'] 	= $data['data_cnt'];

	 $mb_name = $_SESSION['susername'];

     if($mb_name == "최도규" || $mb_name == "서준범" || $mb_name == "지태광" || $mb_name == "채승병" || $mb_name == "여나래"){
          $_SESSION['suserpatientno'] 	= "782844";                 
     }   

    //예약확인
    $url = "http://1.214.232.188:8070/api/v1/";
    $path01 = "check_reserve";    

    $data01 = array(
                "cust_no" =>  $_SESSION['suserpatientno']                
                );

    $json_data = json_encode($data01);
    $curl = curl_init();
    curl_setopt_array($curl, array(
    CURLOPT_URL => $url.$path01,
    CURLOPT_RETURNTRANSFER => true,
    CURLOPT_CUSTOMREQUEST => 'GET',
    CURLOPT_POSTFIELDS => $json_data,
    CURLOPT_HTTPHEADER => array(
        'Content-Type: application/json'),
    ));
    $response = curl_exec($curl);                  
    $data = json_decode($response, true);     

?>
<!-- body -->
<div id="wrap">
	<div id="header">
		<div class="hgroup">
			<h1 class="page-title">나의예약확인</h1>
			<a href="javascript:history.back(-1);" class="history-back"><i class="ip-icon-arrow-back"></i><span class="text-ir">이전 화면</span></a>
		</div>
		<? include_once $GP -> INC_WWW . '/m.header.php'; ?>
	</div>
	<div id="container" class="reserve-history">
    <form id="r_form" name="r_form" class="body" action="?" method="post">
        	<input type="hidden" value="ONLINE_DEL" id="mode" name="mode">
		<div class="body">
			<div class="guide-grid">
				<h2 class="title">나의예약확인</h2>
                <? if(count($data['data']) > 0) { ?>
				<table class="grid">
					<thead>
						<tr>
							<th scope="col" align="center">NO</th>
							<th scope="col" align="center">의사명</th>
							<th scope="col" align="center">예약일</th>
							<th scope="col" align="center">예약시간</th>
                            <th scope="col" align="center">취소</th>
							 <th scope="col" align="center">날짜변경</th>
						</tr>
					</thead>
					<tbody>
                     <? for($i=0;$i<count($data['data']);$i++){ 
                     		$args["dr_mcode"] = $data['data'][$i]['reserv_doct'];
                     		$dr_info = $C_Doctor->Doctor_Info_Code($args);
						    $dr_ps  = $GP -> DOCTOR_POSITION[$dr_info["dr_position"]];	                          
							$dr_idx  = $dr_info["dr_idx"];	                          
                            $recept_no = $data['data'][$i]["recept_no"] ;

                            //취소가능여부확인
                            $url = "http://1.214.232.188:8070/api/v1/";
                            $path02 = "cancel_confirm";    

                            $data02 = array(
                                        "recept_no" =>  $recept_no     
                                        );

                            $json_data = json_encode($data02);
                            $curl = curl_init();
                            curl_setopt_array($curl, array(
                            CURLOPT_URL => $url.$path02,
                            CURLOPT_RETURNTRANSFER => true,
                            CURLOPT_CUSTOMREQUEST => 'GET',
                            CURLOPT_POSTFIELDS => $json_data,
                            CURLOPT_HTTPHEADER => array(
                                'Content-Type: application/json'),
                            ));
                            $response = curl_exec($curl);                  
                            $data03 = json_decode($response, true);							
							
                     ?>
                        <input type="hidden" name="recept_no" id="recept_no" value="<?=$data['data'][$i]["recept_no"]?>" />
						<tr>
							<td align="center"><? echo $i+1;?></td>
							<td align="center"><?=$data['data'][$i]['reserv_doct_nm']?></td>
							<td align="center"><?=substr($data['data'][$i]['reserv_ymd'],0,4)."-".substr($data['data'][$i]['reserv_ymd'],4,2)."-".substr($data['data'][$i]['reserv_ymd'],6,2)?></td>
							<td align="center"><?=substr($data['data'][$i]['reserv_time'],0,2).":".substr($data['data'][$i]['reserv_time'],2,2);?></td>
                            <?  if($data03['data'] > 0) {?>
                            <td align="center"><button type="button" class="next-step" style="margin:0; width:70px; padding:5px;">취소불가</button></td>
                            <? }else{?>
                            <td align="center">							
								<button type="button" class="next-step" style="margin:0; width:35px; padding:2px;font-size:10px;" onclick="online_delete(<?=$recept_no?>)">취소</button>				
                            </td>
							<td align="center">							
								<button type="button" class="next-step" style="margin: 0px; width: 50px; padding: 2px; font-size: 10px; user-select: auto;" onclick="window.location.href='/m/res.process.03.html?cust_no=<?=$_SESSION['suserpatientno']?>&recept_no=<?=$recept_no?>&dr_idx=<?=$dr_idx?>'">날짜변경</button>
							                            </td>
                            <? }?>
						</tr>

                     <? } ?>
					</tbody>
				</table>
              <? }else { ?>
					<span>예약한 내역이 없습니다.</span>		
			  <? } ?>
			</div>
         <? if(count($data) > 0) { 
         		for($i=0;$i<count($data);$i++){ 
                	if($data[$i]["tor_rs_ptype"] =="g"){
         ?>
			<div class="guide-grid"> 
				<h2 class="title">보호자로 예약하신 건입니다. (환자명 : <?=$data[$i]["tor_name"]?>) </h2>
				<table class="grid">
					<thead>
						<tr>
							<th scope="col" align="center">NO</th>
							<th scope="col" align="center">진료과</th>
							<th scope="col" align="center">예약일</th>
							<th scope="col" align="center">예약시간</th>
							<th scope="col" align="center">상태</th>
						</tr>
					</thead>
					<tbody>
						<tr>
							<td align="center"><? echo $i+1;?></td>
							<td align="center"><?=$data[$i]["tor_rs_clinic"]?> - <br><?=$data[$i]["tor_rs_doc"]?> <?=$data[$i]["tor_rs_exam"]?></td>
							<td align="center"><?=date("y-m-d", strtotime($data[$i]['tor_rs_date']))?></td>
							<td align="center"><?=$data[$i]["tor_rs_time"]?></td>
							<td align="center"><?=$GP -> RESERVE_RESULT[$data[$i]["tor_rs_type"]]?></td>
						</tr>
					</tbody>
				</table>
			</div>
        
         <? 		}
         		}
         	}
         ?>
			<!-- <ul class="disc-purple">
				<li>예약변경을 원하시면 취소 후 다시 예약 바랍니다.</li>
			</ul -->>
			<a href="tel:0319809114" class="btn-tel"><small>예약문의</small><i class="ip-icon-tel"></i><span>031-980-9114</span></a>
		</div>
        </form>
	</div>
	<div id="footer">
		<p class="copyright">
			<span>Copyright(c) 2019</span>
			<em>NEW Korea Hospital</em>
		</p>
		<hr class="v-line" />
		<a href="https://www.nkhospital.net/" target="_blank">홈페이지 바로가기</a>
	</div>
</div>
</body>
</html>
<script>	


	function online_delete(recept_no)
	{
		if(!confirm("취소 하시겠습니까?")) return;

		$.ajax({
			type: "POST",
			url: "./proc/online_proc.php",
			data: "mode=ONLINE_DEL&recept_no=" + recept_no,
			dataType: "text",
			success: function(msg) {

				if($.trim(msg) == "true") {
					alert("취소 되었습니다");
					window.location.reload();
					return false;
                } else if($.trim(msg) == "204") {
					alert("검사, 처방존재로 취소가 불가 합니다.");
					window.location.reload();
					return false;
				}else{
					alert('취소에 실패하였습니다.');
					return;
				}
			},
			error: function(xhr, status, error) { alert(error); }
		});

	}
	
</script>